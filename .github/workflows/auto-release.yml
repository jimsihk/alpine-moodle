name: Identify changes, tag and release

on:
  workflow_call:
    inputs:
      image:
        required: true
        type: string

permissions:
  contents: write

jobs:
  auto-tagging:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Load tag history and suggest next tag
        id: analyze_tag_history
        uses: anothrNick/github-tag-action@1.61.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WITH_V: false
          DRY_RUN: true
          DEFAULT_BUMP: patch
          RELEASE_BRANCHES: ${{ vars.RELEASE_BRANCHES }}

      - name: Set next version
        id: next_tag_version
        run: |
          echo "new_tag=${{ steps.analyze_tag_history.outputs.new_tag }}" >> $GITHUB_OUTPUT
          echo "previous_tag=${{ steps.analyze_tag_history.outputs.tag }}" >> $GITHUB_OUTPUT

      - name: Get container Moodle version
        id: moodle_version
        run: |
          docker run -i ${{ inputs.image }} cat /var/www/html/version.php > version.txt
          MOODLE_VERSION=$(grep "\$version" version.txt | sed 's/ //g' | cut -d';' -f1 | cut -d '=' -f2)
          MOODLE_RELEASE=$(grep "\$release" version.txt | sed 's/ //g' | cut -d';' -f1 | cut -d '=' -f2 | sed "s/'//g")
          MOODLE_BRANCH=$(grep "\$branch" version.txt | sed 's/ //g' | cut -d';' -f1 | cut -d '=' -f2 | sed "s/'//g")
          echo "version=${MOODLE_VERSION}" >> $GITHUB_OUTPUT
          echo "release=${MOODLE_RELEASE}" >> $GITHUB_OUTPUT
          echo "branch=${MOODLE_BRANCH}" >> $GITHUB_OUTPUT

          # format moodle version number to tag format
          # <branch>.<version (last 4 digits, leading zero removed)>.0
          # e.g. branch 401 & version 2022112801.04 of v4.1.1 --> 401.104.0
          T1=$MOODLE_BRANCH
          T2=`echo $MOODLE_VERSION | cut -d'.' -f1 | cut -c9- | sed 's/^0*//'`
          T3=`echo $MOODLE_VERSION | cut -d'.' -f2`
          MOODLE_TAG="$T1.$T2$T3.0"
          echo "tag=${MOODLE_TAG}" >> $GITHUB_OUTPUT

          echo "Moodle version: ${MOODLE_VERSION}"
          echo "Moodle release: ${MOODLE_RELEASE}"
          echo "Container tag: ${MOODLE_TAG}"

      - name: Determine change
        id: get_changes
        run: |
          echo "[${{ steps.moodle_version.outputs.tag }}] vs [${{ steps.next_tag_version.outputs.new_tag }}]"
          if [ -n "${{ steps.next_tag_version.outputs.new_tag }}" ]
          then
            # Compare up to minor version
            PREFIX_MOODLE_TAG=`echo ${{ steps.moodle_version.outputs.tag }} | cut -d'.' -f1,2`
            PREFIX_NEW_TAG=`echo ${{ steps.next_tag_version.outputs.new_tag }} | cut -d'.' -f1,2`
            if [ "$PREFIX_MOODLE_TAG" = "$PREFIX_NEW_TAG" ];
            then
              # same Moodle minor version
              echo "Use ${{ steps.next_tag_version.outputs.new_tag }}"
              echo "new_tag=${{ steps.next_tag_version.outputs.new_tag }}" >> $GITHUB_OUTPUT
            else
              # Moodle minor version changed
              echo "Use ${{ steps.moodle_version.outputs.tag }}"
              echo "new_tag=${{ steps.moodle_version.outputs.tag }}" >> $GITHUB_OUTPUT
            fi
          else
            echo "No change is detected"
            echo "new_tag=${{ steps.next_tag_version.outputs.previous_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Generate release name
        id: release_detail
        run: |
          R1=`echo "${{ steps.moodle_version.outputs.release }}" | sed 's/ //g' | cut -d'(' -f1 | sed 's/\+//g'`
          R2=`echo "${{ steps.moodle_version.outputs.version }}" | cut -d'.' -f2`
          R3=`echo "${{ steps.get_changes.outputs.new_tag }}" | cut -d'.' -f3`
          R_NAME="v$R1.$R2-$R3"
          echo "release_name=$R_NAME" >> $GITHUB_OUTPUT
          echo "Release name: $R_NAME"

      - name: Tag and create a GitHub release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.get_changes.outputs.new_tag }}
          commit: ${{ github.sha }}
          name: Test ${{ steps.release_detail.outputs.release_name }}
          skipIfReleaseExists: true
          allowUpdates: false
          generateReleaseNotes: true
